{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved</title>
    <link rel="stylesheet" href="{% static 'styles/styles.css' %}?v=1.0">
    <link rel="stylesheet" href="{% static 'styles/saved.css' %}?v=1.0">
</head>
<body>
<div id="sidebar">
    <div id="sidebar_content" class="hidden">
        <p><a href="{% url 'core:profilepage' %}">Profile</a></p>
        <p><a href="{% url 'core:home' %}">Home</a></p>
        <p><a href="{% url 'core:organization' %}">Organization</a></p>
        <p><a href="{% url 'core:saved' %}">Saved</a></p>
        <p><a href="{% url 'core:email' %}">Email</a></p>
    </div>
    <hr class="divider_sidebar"/>
    
    <div class="notification_container">
        <!-- Notification Pop-Up -->
            <div id="notification_popup" class="hidden">
            <h2>Notifications</h2><button id="close_notification_popup" class="close-btn">&times;</button>
            <div id="notification_list">
                <ul>
                    <li class="notification_item" data-detail="General meeting at 10:30 AM on January 3, 2024, will be held in the main conference room. All employees are expected to attend this important session where key company updates and strategic initiatives for the upcoming year will be discussed.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">General meeting at 10:30AM on Jan 3, 202 General meeting at 10:30AM on Jan 3, 202</p>
                        <p class="posted-by">- Imee Duterte</p>
                    </li>
                    <li class="notification_item" data-detail="Another meeting detail here.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">Another meeting detail here General meeting at 10:30AM on Jan 3, 202 General meet</p>
                        <p class="posted-by">- John Doe</p>
                    </li>
                    <li class="notification_item" data-detail="Another meeting detail here.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">Another meeting detail here</p>
                        <p class="posted-by">- Sarah Marcos</p>
                    </li>
                    <li class="notification_item" data-detail="Another meeting detail here.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">Another meeting detail here</p>
                        <p class="posted-by">- Ginno Arostique</p>
                    </li>
                    <li class="notification_item" data-detail="Another meeting detail here.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">Another meeting detail here</p>
                        <p class="posted-by">- Ginno Arostique</p>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Detailed Notification -->
        <div id="detailed_notification" class="hidden">
            <h2 id="notification_title">Schedule Update</h2><p class="notification_date">Yesterday, January 29, 2025</p>
            <button id="close_detailed_notification" class="close-btn">&times;</button>
            <p id="notification_detail"></p>
            <p class="posted-by">- Imee Duterte, Team Head</p>
            <button class="respond-btn">Respond</button>
        </div>
    </div>
    
    <div id="sidebar_icns_grp">
        <div class="nav_item">
            <img id="nav_icon" class="sidebar_icns" style="margin-bottom: -6px;" src="{% static 'Images/Navigation.png' %}" alt="Navigate">
            <p>Navigate</p>
        </div>
        <div class="nav_item">
            <img class="sidebar_icns" src="{% static 'Images/Notification.png' %}" alt="Notification">
            <p id="notification_paragraph">Notification</p>
        </div>
        <div class="nav_item">
            <img class="sidebar_icns" src="{% static 'Images/Settings.png' %}" alt="Settings">
            <p>Settings</p>
        </div>
    </div>
</div>
    
        <div id="header">
            <div>
                <img id="logo" src="{% static 'Images/Logo.png' %}" alt="ARC.AI Logo">
            </div>
            <div id="header_nav" class="text_white">
                <p><a href="{% url 'core:home' %}" class="{% if active_page == 'home' %}active{% endif %}">Home</a></p>
                <p><a href="{% url 'core:organization' %}" class="{% if active_page == 'organization' %}active{% endif %}">Organization</a></p>
                <p><a href="{% url 'core:saved' %}" class="{% if active_page == 'saved' %}active{% endif %}">Saved</a></p>
                <p><a href="{% url 'core:email' %}" class="{% if active_page == 'email' %}active{% endif %}">Email</a></p>
                <p><a href="{% url 'core:profilepage' %}" class="{% if active_page == 'email' %}active{% endif %}">Profile</a></p>
            </div>
            <div>
                <img id="account_icn" src="{% static 'Images/Account.png' %}" alt="Account">
            </div>
        </div>
    <div id="content">
        <h1>Folders</h1>
        <div id="folder_items">
        {% for folder in folders %}
            <p class="folders">{{ folder }}</p>
        {% endfor %}
        </div>
        
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h1 class="titles">Files</h1>
            
            <!-- Horizontal Line Between Folders and Dropdown -->
            <div class="horizontal-line"></div>
            
                <!-- {% for message in messages %}
                <h3 style="color: red;">message</h3>
                {% endfor %} -->

            <!-- Dropdown Button -->
            <img src="{% static 'Images/dots.png' %}" alt="Dropdown Icon" class="dropdown-icon" onclick="toggleDropdown()" style="width: 40px; height: 40px; cursor: pointer;">
            <div class="dropdown-content" id="myDropdown">
                <!-- File Upload -->
                <form action="{% url 'core:upload_file_to_drive' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="file" name="file" multiple required>
                    <button type="submit">Upload</button>
                </form>
                <hr class="dropdown-divider">

                <!-- DELETE Button -->
                <a href="#" onclick="toggleCheckboxes()">DELETE</a>
            </div>
        </div>

        <!-- File List -->
        <ul id="file-list">
            {% for file in files %}
                <li>
                    <input type="checkbox" class="file-checkbox" style="display: none;" data-file-id="{{ file.id }}">
                    <a href="{{ file.webViewLink }}" target="_blank">
                        {{ file.name }}
                    </a>
                    <p>Type: {{ file.mimeType }}</p>
                </li>
            {% empty %}
                <li>No files found in Google Drive.</li>
            {% endfor %}
        </ul>

        <!-- Delete Selected Files Button -->
        <button id="delete-selected-btn" style="display: none;" onclick="deleteSelectedFiles()">Delete Selected Files</button>

        <h3>Trash</h3>
        <div id="file_items">
        {% for trash_file in trash %}
            <p class="file">{{ trash_file }}</p>
            <hr class="long-line">
        {% endfor %}
        </div>
    </div>
    <script src="{% static 'js/sidebar.js' %}"></script>
</body>

<script>
    function toggleDropdown() {
        document.getElementById("myDropdown").classList.toggle("show");
    }
    
    // Optional: Close the dropdown if clicking outside
    window.onclick = function(event) {
        // Check if click was NOT on the image
        if (!event.target.classList.contains('dropdown-icon')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }

 let checkboxesVisible = false; // Track the visibility state of checkboxes

    function toggleCheckboxes() {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        const deleteButton = document.getElementById('delete-selected-btn');
        checkboxesVisible = !checkboxesVisible; // Toggle the visibility state

        // Show or hide checkboxes
        checkboxes.forEach(checkbox => {
            checkbox.style.display = checkboxesVisible ? 'inline-block' : 'none';
        });

        // Show or hide the delete button
        deleteButton.style.display = checkboxesVisible ? 'block' : 'none';

        // Add or remove the event listener for hiding checkboxes
        if (checkboxesVisible) {
            window.addEventListener('click', hideCheckboxesOnClickOutside);
        } else {
            window.removeEventListener('click', hideCheckboxesOnClickOutside);
        }
    }

    function hideCheckboxesOnClickOutside(event) {
        const deleteButton = document.querySelector('[onclick="toggleCheckboxes()"]');
        const checkboxes = document.querySelectorAll('.file-checkbox');
        const isClickOnCheckbox = Array.from(checkboxes).some(checkbox => checkbox.contains(event.target));
        if (!deleteButton.contains(event.target) && !isClickOnCheckbox) {
            // Hide checkboxes
            checkboxes.forEach(checkbox => {
                checkbox.style.display = 'none';
            });

            // Hide the delete button
            document.getElementById('delete-selected-btn').style.display = 'none';

            checkboxesVisible = false; // Reset visibility state
            window.removeEventListener('click', hideCheckboxesOnClickOutside); // Remove the event listener
        }
    }

    function deleteSelectedFiles() {
        const selectedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
        const fileIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.fileId);

        if (fileIds.length === 0) {
            alert('No files selected for deletion.');
            return;
        }

        if (confirm('Are you sure you want to delete the selected files?')) {
            // Create a FormData object to send the file IDs
            const formData = new FormData();
            fileIds.forEach(fileId => formData.append('file_ids[]', fileId));

            // Send an AJAX request to the backend
            fetch("{% url 'core:delete_files_from_drive' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token for security
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);

                    // Remove the deleted files from the DOM
                    selectedCheckboxes.forEach(checkbox => {
                        checkbox.closest('li').remove();
                    });

                    // Hide the delete button after deletion
                    document.getElementById('delete-selected-btn').style.display = 'none';
                } else {
                    alert(data.error || 'Failed to delete the files.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the files.');
            });
        }
    }
</script>
    
</html>