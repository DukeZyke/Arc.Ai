{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved</title>
    <link rel="stylesheet" href="{% static 'styles/styles.css' %}?v=1.0">
    <link rel="stylesheet" href="{% static 'styles/saved.css' %}?v=1.0">
</head>
<body>
<div id="sidebar">
    <div id="sidebar_content" class="hidden">
        <p><a href="{% url 'core:profilepage' request.user.pk  %}">Profile</a></p>
        <p><a href="{% url 'core:home' %}">Home</a></p>
        <p><a href="{% url 'core:organization' %}">Organization</a></p>
        <p><a href="{% url 'core:saved' %}">Saved</a></p>
        <p><a href="{% url 'core:email' %}">Email</a></p>
    </div>
    <hr class="divider_sidebar"/>
    
    <div class="notification_container">
        <!-- Notification Pop-Up -->
            <div id="notification_popup" class="hidden">
            <h2>Notifications</h2><button id="close_notification_popup" class="close-btn">&times;</button>
            <div id="notification_list">
                <ul>
                    <li class="notification_item" data-detail="General meeting at 10:30 AM on January 3, 2024, will be held in the main conference room. All employees are expected to attend this important session where key company updates and strategic initiatives for the upcoming year will be discussed.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">General meeting at 10:30AM on Jan 3, 202 General meeting at 10:30AM on Jan 3, 202</p>
                        <p class="posted-by">- Imee Duterte</p>
                    </li>
                    <li class="notification_item" data-detail="Another meeting detail here.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">Another meeting detail here General meeting at 10:30AM on Jan 3, 202 General meet</p>
                        <p class="posted-by">- John Doe</p>
                    </li>
                    <li class="notification_item" data-detail="Another meeting detail here.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">Another meeting detail here</p>
                        <p class="posted-by">- Sarah Marcos</p>
                    </li>
                    <li class="notification_item" data-detail="Another meeting detail here.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">Another meeting detail here</p>
                        <p class="posted-by">- Ginno Arostique</p>
                    </li>
                    <li class="notification_item" data-detail="Another meeting detail here.">
                        <p>Schedule Update <span>Yesterday</span></p>
                        <p class="short-description">Another meeting detail here</p>
                        <p class="posted-by">- Ginno Arostique</p>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Detailed Notification -->
        <div id="detailed_notification" class="hidden">
            <h2 id="notification_title">Schedule Update</h2><p class="notification_date">Yesterday, January 29, 2025</p>
            <button id="close_detailed_notification" class="close-btn">&times;</button>
            <p id="notification_detail"></p>
            <p class="posted-by">- Imee Duterte, Team Head</p>
            <button class="respond-btn">Respond</button>
        </div>
    </div>
    
    <div id="sidebar_icns_grp">
        <div class="nav_item">
            <img id="nav_icon" class="sidebar_icns" style="margin-bottom: -6px;" src="{% static 'Images/Navigation.png' %}" alt="Navigate">
            <p>Navigate</p>
        </div>
        <div class="nav_item">
            <img class="sidebar_icns" src="{% static 'Images/Notification.png' %}" alt="Notification">
            <p id="notification_paragraph">Notification</p>
        </div>
        <div class="nav_item">
            <img class="sidebar_icns" src="{% static 'Images/Settings.png' %}" alt="Settings">
            <p>Settings</p>
        </div>
    </div>
</div>
    
        <div id="header">
            <div>
                <img id="logo" src="{% static 'Images/Logo.png' %}" alt="ARC.AI Logo">
            </div>
            <div id="header_nav" class="text_white">
                <p><a href="{% url 'core:home' %}" class="{% if active_page == 'home' %}active{% endif %}">Home</a></p>
                <p><a href="{% url 'core:organization' %}" class="{% if active_page == 'organization' %}active{% endif %}">Organization</a></p>
                <p><a href="{% url 'core:saved' %}" class="{% if active_page == 'saved' %}active{% endif %}">Saved</a></p>
                <p><a href="{% url 'core:email' %}" class="{% if active_page == 'email' %}active{% endif %}">Email</a></p>
                <p><a href="{% url 'core:profilepage' request.user.pk  %}" class="{% if active_page == 'email' %}active{% endif %}">Profile</a></p>
            </div>
            <div>
                <img id="account_icn" src="{% static 'Images/Account.png' %}" alt="Account">
            </div>
        </div>

        
    <div id="content">

        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h1>Folders</h1>

            <div class="horizontal-line"></div>


            <!-- Dropdown Button -->
            <img src="{% static 'Images/dots copy.png' %}" alt="Dropdown Icon" class="dropdown-icon" onclick="toggleDropdownFolders()" style="width: 40px; height: 40px; cursor: pointer;">
            <div class="dropdown-content" id="myDropdownFolders">
                <!-- Folder Creation -->
                <form action="{% url 'core:create_folder_in_drive' %}" method="post">
                    {% csrf_token %}
                    <input class="Fn" type="text" name="folder_name" placeholder="Folder Name" required>
                     <hr class="dropdown-divider">
                    <button class="create" type="submit">Create</button>
                </form>
                <hr class="dropdown-divider">

                <!-- DELETE Button -->
                <button class="delete"  onclick="toggleFolderCheckboxes()">DELETE</button>
                 <hr class="dropdown-divider">
            </div>
        </div>

            <div id="folder_items">
                {% for folder in folders %}
                    <div class="folder-item">
                            <div class="folder-content">
                                <input type="checkbox" class="folder-checkbox" style="display: none;" data-folder-id="{{ folder.id }}">
                                    <a href="{% url 'core:view_folder_contents' folder.id %}">{{ folder.name }}</a>
                             </div>
                    </div>
                {% empty %}
                    <p>No folders found.</p>
                {% endfor %}
            </div>

            <!-- Add delete selected folders button -->
            <button id="delete-selected-folders-btn" style="display: none;" onclick="deleteSelectedFolders()">Delete Selected Folders</button>

            <!-- Hidden form for folder deletion -->
            <form id="delete-folders-form" action="{% url 'core:delete_folders' %}" method="post" style="display: none;">
                {% csrf_token %}
            </form>



                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h1 class="titles">Files</h1>
                    
                    <div class="horizontal-line"></div>
                    
                    <!-- Dropdown Button -->
                    <img src="{% static 'Images/dots.png' %}" alt="Dropdown Icon" class="dropdown-icon" onclick="toggleDropdownFiles()" style="width: 40px; height: 40px; cursor: pointer;">
                    <div class="dropdown-content2" id="myDropdown">
                        <!-- File Upload -->
                        <form action="{% url 'core:upload_file_to_drive' %}" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="folder_id" value="{{ folder_id|default:ROOT_FOLDER_ID }}">
                            <input  style=" margin: 10px auto auto 5px; padding: 8px 16px; width:auto;"type="file" name="file" multiple required>
                            <hr class="dropdown-divider">
                            <button class="upload" type="submit">Upload</button>
                        </form>
                        <hr class="dropdown-divider">

                        <!-- DELETE Button --> <button class="trash" onclick="toggleCheckboxes()">MOVE TO TRASH</button>
                          <hr class="dropdown-divider">
                    </div>
                </div>

                <div id="file_items">
                    <ul class="file-list">
                            <div class="horizontal-line"></div>
                            {% for file in files %}
                                <li class="file-item">
                                    <div class="file-icon">
                                        <input type="checkbox" class ="file-checkbox"
                                        style="display: none;" data-file-id="{{ file.file_id }}">
                                        <img src="{% static file.icon %}" alt="File Icon">
                                    </div>
                                    <div class="file-details">
                                        <a href="https://drive.google.com/file/d/{{ file.file_id }}/view" target="_blank" class="file-name">{{ file.name }}</a>
                                        <span class="file-owner">{{ file.owner }}</span>
                                        <span class="file-date">{{ file.date }}</span>
                                        <span class="file-size">{{ file.size }}</span>
                                    </div>
                                    <div class="file-actions">
                                        <button class="action-button" onclick="showFileOptions(this)">⋮</button>
                                            <div class="file-options-dropdown" style="display: none;">
                                            <div class="option" onclick="handleSingleFileTrash(this)">Move to Trash</div>
                                        </div>
                                    </div>
                                </li>
                                <div class="horizontal-line"></div>
                            {% empty %}
                                <li>No files uploaded yet.</li>
                            {% endfor %}
                        </ul>

                    <!-- Single Delete Button that appears when checkboxes are shown -->
                    <div class="action-buttons-group" id="action-buttons-group" style="display: none;">
                        <button id="delete-selected-btn" onclick="moveToTrashSelectedFiles()">Move Selected Files to Trash</button>
                        <button id="undo-selection-btn" onclick="undoSelection()">Undo</button>
                    </div>

                    <!-- Keep the form for the CSRF token and folder ID -->
                    <form id="delete-files-form" action="{% url 'core:move_files_to_trash' %}" method="post" style="display: none;">
                        {% csrf_token %}
                        <input type="hidden" name="folder_id" value="{{ folder_id|default:ROOT_FOLDER_ID }}">
                    </form>
                    </div>
                
        

            <div style="display: flex; align-items: center; justify-content: space-between;">


            <h3>Trash</h3>
            <div class="horizontal-line"></div>
            <!-- Dropdown Button -->
            <img src="{% static 'Images/dots copy 2.png' %}" alt="Dropdown Icon" class="dropdown-icon" onclick="toggleDropdownTrash()" style="width: 40px; height: 40px; cursor: pointer;">
                <div class="dropdown-content3" id="trashDropdown">
                    <!-- Remove All Trash Button -->
                    <form action="{% url 'core:empty_trash' %}" method="post">
                        {% csrf_token %}
                        <button class="rat" type="submit" onclick="return confirm('Are you sure you want to permanently delete all items in trash?')">Remove All Trash</button>
                    </form>
                    
                    <!-- Restore Files Button -->
                    <hr class="dropdown-divider">
                    <form action="{% url 'core:restore_from_trash' %}" method="post">
                        {% csrf_token %}
                        <button class="raf" type="submit" onclick="return confirm('Restore all files from trash?')">Restore All Files</button>
                    </form>
                </div>




            </div>
    <div id="file_items">
    <ul class="file-list">
        {% for file in trash %}
            <div class="horizontal-line"></div>
            <li class="file-item">
                <div class="file-icon">
                    <img src="{% static file.icon %}" alt="File Icon">
                </div>
                <div class="file-details">
                    <a href="https://drive.google.com/file/d/{{ file.file_id }}/view" target="_blank" class="file-name">{{ file.name }}</a>
                    <span class="file-owner">{{ file.owner }}</span>
                    <span class="file-date">{{ file.date }}</span>
                    <span class="file-size">{{ file.size }}</span>
                </div>
            </li>
            <div class="horizontal-line"></div>
        {% empty %}
            <li>Trash is empty</li>
        {% endfor %}
    </ul>
</div>
    </div>
    <script src="{% static 'js/sidebar.js' %}"></script>
    <script src="{% static 'js/saved.js' %}"></script>
</body>

<script>
    function toggleDropdownFiles() {
        document.getElementById("myDropdown").classList.toggle("show");
    }

    function moveToTrashSelectedFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox:checked');
    const fileIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.fileId);
    const form = document.getElementById('delete-files-form');

    if (fileIds.length === 0) {
        alert('No files selected to move to trash.');
        return;
    }

    if (confirm(`Are you sure you want to move ${fileIds.length} selected file(s) to trash?`)) {
        const formData = new FormData(form);
        fileIds.forEach(fileId => formData.append('file_ids[]', fileId));

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Check if we're in root folder and redirect accordingly
                if (data.is_root_folder) {
                    window.location.href = '/saved/';
                } else {
                    window.location.href = `/folder/${data.folder_id}/`;
                }
            } else {
                alert(data.error || 'An error occurred while moving files to trash.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while moving files to trash.');
        });
    }
}

    function toggleFolderCheckboxes() {
        const checkboxes = document.querySelectorAll('.folder-checkbox');
        const deleteButton = document.getElementById('delete-selected-folders-btn');
        
        // Check if checkboxes are currently hidden
        const isHidden = checkboxes.length > 0 && checkboxes[0].style.display === 'none';
        
        // Toggle visibility
        checkboxes.forEach(checkbox => {
            checkbox.style.display = isHidden ? 'inline-block' : 'none';
        });
        
        // Toggle delete button visibility
        deleteButton.style.display = isHidden ? 'block' : 'none';
        
        // Close the dropdown
        document.getElementById('myDropdownFolders').classList.remove('show');
    }
    
    function deleteSelectedFolders() {
        const checkboxes = document.querySelectorAll('.folder-checkbox:checked');
        const folderIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.folderId);
        const form = document.getElementById('delete-folders-form');
        
        if (folderIds.length === 0) {
            alert('No folders selected for deletion.');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${folderIds.length} selected folder(s)?`)) {
            const formData = new FormData(form);
            folderIds.forEach(folderId => formData.append('folder_ids[]', folderId));
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.error || 'An error occurred while deleting folders.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting folders.');
            });
        }
    }

    function showFileOptions(button) {
    // Close any open dropdowns first
    const allDropdowns = document.querySelectorAll('.file-options-dropdown');
    allDropdowns.forEach(dropdown => {
        if (dropdown !== button.nextElementSibling) {
            dropdown.style.display = 'none';
        }
    });

    // Toggle the clicked dropdown
    const dropdown = button.nextElementSibling;
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.matches('.action-button')) {
        const dropdowns = document.querySelectorAll('.file-options-dropdown');
        dropdowns.forEach(dropdown => {
            dropdown.style.display = 'none';
        });
    }
});

function handleSingleFileTrash(optionElement) {
    // Find the parent file-item
    const fileItem = optionElement.closest('.file-item');
    const checkbox = fileItem.querySelector('.file-checkbox');
    
    // Show all checkboxes
    const allCheckboxes = document.querySelectorAll('.file-checkbox');
    allCheckboxes.forEach(cb => {
        cb.style.display = 'inline-block';
        cb.checked = false; // Uncheck all checkboxes first
    });
    
    // Check only the selected file's checkbox
    checkbox.checked = true;
    
    // Show the action buttons group
    document.getElementById('action-buttons-group').style.display = 'flex';
    
    // Close the dropdown
    optionElement.closest('.file-options-dropdown').style.display = 'none';
}

function toggleCheckboxes() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    const actionButtonsGroup = document.getElementById('action-buttons-group');
    
    // Check if checkboxes are currently hidden
    const isHidden = checkboxes.length > 0 && checkboxes[0].style.display === 'none';
    
    // Toggle visibility
    checkboxes.forEach(checkbox => {
        checkbox.style.display = isHidden ? 'inline-block' : 'none';
        checkbox.checked = false; // Uncheck when toggling
    });
    
    // Toggle action buttons group visibility
    actionButtonsGroup.style.display = isHidden ? 'flex' : 'none';
}

function undoSelection() {
    // Hide all checkboxes
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.style.display = 'none';
        checkbox.checked = false;
    });
    
    // Hide the action buttons group
    document.getElementById('action-buttons-group').style.display = 'none';
}
</script>
    
</html>